<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMSilks Pro V7</title>
    <meta name="theme-color" content="#0056b3">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; padding: 20px; color: #333; }
        .container { max-width: 980px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        #networkStatus { position: fixed; top: 0; left: 0; width: 100%; text-align: center; padding: 5px; font-size: 12px; font-weight: bold; color: white; z-index: 10000; display: none; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }

        /* OVERLAYS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 86, 179, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .box-content { background: white; padding: 30px; border-radius: 10px; text-align: center; color: #333; width: 350px; max-width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .box-content input, .box-content select { font-size: 16px; padding: 10px; width: 90%; border: 2px solid #ddd; border-radius: 5px; margin: 10px 0; }
        
        .po-list { text-align: left; max-height: 200px; overflow-y: auto; margin: 15px 0; border: 1px solid #eee; padding: 10px; }
        .po-item { display: flex; align-items: center; border-bottom: 1px solid #f1f1f1; padding: 5px 0; }
        .po-item input { width: auto; margin-right: 10px; transform: scale(1.5); }
        .po-item label { font-size: 13px; cursor: pointer; flex: 1; }

        .btn-login { background-color: #28a745; color: white; width: 100%; padding: 12px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-cancel { background-color: #dc3545; color: white; width: 48%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-confirm { background-color: #0056b3; color: white; width: 48%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }

        .role-badge { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-left: 10px; }
        .role-admin { background: #dc3545; color: white; }
        .role-sales { background: #17a2b8; color: white; }
        
        header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #0056b3; padding-bottom: 15px; }
        header h1 { margin: 0; color: #0056b3; font-size: 32px; text-transform: uppercase; letter-spacing: 1px; }
        header .sub-head { font-size: 14px; color: #555; margin-top: 3px; font-weight: bold; }
        header .web-info { font-size: 13px; color: #0056b3; margin-top: 5px; }
        
        .input-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .input-box { flex: 1; min-width: 150px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 13px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        .section-box { background: #eef2f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1d9e6; }
        .section-title { font-size: 18px; margin-bottom: 15px; color: #0056b3; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 5px; }

        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; color: white; transition: 0.3s; margin-top: 10px; font-weight: bold; }
        .btn-add { background-color: #28a745; width: 100%; padding: 12px; font-size: 16px; }
        
        .btn-inv { background-color: #0056b3; } 
        .btn-quote { background-color: #ffc107; color: #333; } 
        .btn-receipt { background-color: #20c997; color: white; } /* Money In */
        .btn-payment { background-color: #e83e8c; color: white; } /* Money Out */
        .btn-stmt { background-color: #6610f2; color: white; } 
        .btn-po { background-color: #fd7e14; color: white; } 
        .btn-prod { background-color: #6f42c1; } 
        
        .btn-wa { background-color: #25D366; }
        .btn-print { background-color: #6c757d; }
        .btn-close { background-color: #dc3545; }
        
        .btn-save-doc { background-color: #17a2b8; font-weight: bold; padding: 12px 20px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }

        .bottom-actions { margin-top: 40px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-save { background-color: #17a2b8; padding: 15px; font-size: 18px; width: 100%; margin-bottom: 10px; }
        .btn-history { background-color: #343a40; padding: 12px; flex: 1; }
        .btn-sync { background-color: #0056b3; padding: 12px; flex: 1; margin-top: 10px; }
        .btn-clear { background-color: #dc3545; padding: 12px; width: 100%; margin-top: 15px; }
        
        .admin-controls { display: none; gap: 10px; width: 100%; }
        .admin-only-btn { display: none; }

        .hidden-input { display: none; margin-top: 5px; }

        #savedListArea { display: none; background: #fff8e1; padding: 15px; border: 1px solid #ffeeba; margin-bottom: 20px; border-radius: 5px; }
        .saved-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; background: white; margin-bottom: 5px; }
        
        .sync-pending { color: #dc3545; font-weight: bold; font-size: 11px; }
        .sync-done { color: #28a745; font-weight: bold; font-size: 11px; }

        /* RECEIPT STYLES */
        .receipt-box { display: none; border: 2px solid #333; padding: 20px; margin-top: 20px; background: #fff; position: relative; }
        .receipt-row { display: flex; margin-bottom: 15px; align-items: baseline; }
        .receipt-label { font-weight: bold; width: 150px; min-width: 120px; color: #555; }
        .receipt-value { border-bottom: 1px dotted #333; flex: 1; padding-bottom: 5px; font-weight: 500; font-size: 18px; color: #000; }
        .receipt-amount-box { border: 2px solid #333; padding: 10px 20px; font-size: 24px; font-weight: bold; display: inline-block; margin-top: 20px; background: #f8f9fa; }
        .receipt-footer { display: flex; justify-content: space-between; margin-top: 50px; }
        .receipt-sig { border-top: 1px solid #333; width: 200px; text-align: center; padding-top: 5px; font-size: 14px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #dee2e6; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f1f3f5; font-weight: bold; }
        .text-right { text-align: right; }
        
        .amount-words { margin-top: 15px; font-style: italic; font-weight: bold; border-top: 1px solid #eee; padding-top: 10px; }
        .quote-terms { font-size: 11px; margin-top: 20px; color: #555; display: none; }

        #docView { display: none; }

        @media print {
            body * { visibility: hidden; }
            #docView, #docView * { visibility: visible; }
            #docView { position: absolute; left: 0; top: 0; width: 100%; display: block; }
            .no-print { display: none !important; }
            input { border: none; background: transparent; }
        }
    </style>
</head>
<body>

<div id="networkStatus"></div>

<div id="loginOverlay" class="overlay">
    <div style="margin-bottom: 20px; font-size: 24px; font-weight: bold; color:white;">AMSilks Trading System</div>
    <div class="box-content">
        <h3>Login Required</h3>
        <p style="font-size: 12px; color: #666;">Enter PIN to access</p>
        <input type="password" id="loginPin" placeholder="PIN" maxlength="4" onkeyup="if(event.key === 'Enter') checkLogin()">
        <button class="btn-login" onclick="checkLogin()">Unlock</button>
    </div>
</div>

<div id="poModal" class="overlay" style="display:none; z-index:10001;">
    <div class="box-content" style="text-align:left;">
        <h3 style="margin-top:0; text-align:center;">Generate Purchase Order</h3>
        <label style="font-size:12px;">Supplier Name:</label>
        <input type="text" id="poSupplierInput" placeholder="Enter Supplier Name" list="savedNamesList">
        <div class="po-list" id="poListContainer"></div>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-cancel" onclick="document.getElementById('poModal').style.display='none'">Cancel</button>
            <button class="btn-confirm" onclick="generatePOFromSelection()">Generate PO</button>
        </div>
    </div>
</div>

<div id="statementModal" class="overlay" style="display:none; z-index:10001;">
    <div class="box-content" style="text-align:left;">
        <h3 style="margin-top:0; text-align:center;">Generate Statement</h3>
        <label>Select Type:</label>
        <select id="stmtType">
            <option value="Customer">Customer Statement</option>
            <option value="Supplier">Supplier Statement</option>
        </select>
        <label>Name (Search):</label>
        <input type="text" id="stmtNameInput" placeholder="Enter Name Exactly..." list="savedNamesList">
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-cancel" onclick="document.getElementById('statementModal').style.display='none'">Close</button>
            <button class="btn-stmt" onclick="generateStatement()" style="width:48%; padding:10px; border:none; border-radius:5px; cursor:pointer;">Generate</button>
        </div>
    </div>
</div>

<div id="directReceiptModal" class="overlay" style="display:none; z-index:10001;">
    <div class="box-content" style="text-align:left;">
        <h3 style="margin-top:0; text-align:center; color:#20c997;">üí∞ Money In (Receipt)</h3>
        <label>Received From (Customer):</label>
        <input type="text" id="rcptCustName" placeholder="Customer Name" list="savedNamesList">
        <label>Amount Received:</label>
        <input type="number" id="rcptCustAmount" placeholder="0.00">
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-cancel" onclick="document.getElementById('directReceiptModal').style.display='none'">Close</button>
            <button class="btn-receipt" onclick="generateDirectReceipt()" style="width:48%; padding:10px; border:none; border-radius:5px; cursor:pointer;">Create Receipt</button>
        </div>
    </div>
</div>

<div id="paymentModal" class="overlay" style="display:none; z-index:10001;">
    <div class="box-content" style="text-align:left;">
        <h3 style="margin-top:0; text-align:center; color:#e83e8c;">üí∏ Money Out (Payment)</h3>
        <label>Paid To (Supplier):</label>
        <input type="text" id="paySuppName" placeholder="Supplier Name" list="savedNamesList">
        <label>Amount Paid:</label>
        <input type="number" id="payAmount" placeholder="0.00">
        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button class="btn-cancel" onclick="document.getElementById('paymentModal').style.display='none'">Close</button>
            <button class="btn-payment" onclick="generatePaymentVoucher()" style="width:48%; padding:10px; border:none; border-radius:5px; cursor:pointer;">Create Voucher</button>
        </div>
    </div>
</div>

<datalist id="savedNamesList"></datalist>

<div class="container" id="editorSection">
    
    <header>
        <h1>AMSilks Trading <span id="userRoleBadge" class="role-badge"></span></h1>
        <div class="sub-head">Doha - Qatar | CR No: 224866</div>
        <div style="text-align: right; float: right;">
            <button onclick="logout()" style="background:none; border:none; color:#dc3545; cursor:pointer; font-size:12px;">Logout</button>
        </div>
        <div class="web-info">www.amsilks.com | info@amsilks.com</div>
    </header>

    <div id="savedListArea">
        <h3>Saved Orders (History)</h3>
        <button id="pendingSyncBtn" class="btn btn-sync" style="background:#dc3545; display:none; margin-bottom:10px;" onclick="syncPendingOrders()">
            ‚ö†Ô∏è Sync Pending Orders to Cloud
        </button>
        <div id="savedItemsContainer"></div>
        <button class="btn btn-close" onclick="toggleSavedList()" style="margin-top:10px;">Close List</button>
    </div>

    <div class="input-group">
        <div class="input-box"><label>Customer Name</label><input type="text" id="custName" list="savedNamesList"></div>
        <div class="input-box"><label>Customer Phone</label><input type="tel" id="custPhone"></div>
        <div class="input-box" style="background: #fff3cd; border-radius: 5px; padding: 5px;">
            <label>Previous Balance (Old Due)</label>
            <input type="number" id="prevBalanceInput" value="0" style="font-weight:bold; color:#856404;" oninput="calculateGrandTotal()">
        </div>
    </div>

    <div class="section-box">
        <div class="section-title">Add Measurements (For Invoice/Quote)</div>
        <div class="input-group">
            <div class="input-box"><label>Building Type</label><select id="buildingType" onchange="updateRoomOptions()"><option value="House">House / Villa</option><option value="Tower">Tower / Building</option><option value="Other">Other</option></select><input type="text" id="towerNameInput" class="hidden-input" placeholder="Enter Tower Name"></div>
            <div class="input-box"><label>Floor</label><select id="floorSelect" onchange="checkManualInput('floorSelect', 'manualFloor')"><option value="Ground Floor">Ground Floor</option><option value="First Floor">First Floor</option><option value="Second Floor">Second Floor</option><option value="Other">Other</option></select><input type="text" id="manualFloor" class="hidden-input" placeholder="Type Floor"></div>
            <div class="input-box"><label>Room Name</label><select id="roomSelect" onchange="checkManualInput('roomSelect', 'manualRoom')"></select><input type="text" id="manualRoom" class="hidden-input" placeholder="Type Room Name"></div>
        </div>
        <div class="input-group">
            <div class="input-box"><label>Type</label><select id="type" onchange="toggleFields()"><option value="Heavy Curtain">Heavy Curtain</option><option value="Sheer Curtain">Sheer Curtain</option><option value="Roller Blind">Roller Blind</option><option value="Roman Blind">Roman Blind</option><option value="Other">Other</option></select></div>
            <div class="input-box" id="fullnessBox"><label>Fullness (Ratio)</label><select id="fullnessSelect" onchange="checkCustomFullness()"><option value="3">Normal (1 x 3)</option><option value="2">Project (1 x 2)</option><option value="custom">Custom</option></select><input type="number" id="customFullnessInput" class="hidden-input" placeholder="Enter Ratio (e.g. 2.5)" step="0.1"></div>
            <div class="input-box" id="fabricWidthBox"><label>Select Fabric Width</label><select id="fabricWidthSelect"><option value="1.4">Standard (140 cm)</option><option value="2.8">Wide (280 cm)</option><option value="3.0">Wide (300 cm)</option></select></div>
            <div class="input-box"><label>Catalog Name/No</label><input type="text" id="catalog"></div>
            <div class="input-box"><label>Fabric Number</label><input type="text" id="fabricNo"></div>
        </div>
        <div class="input-group">
            <div class="input-box" style="max-width: 100px;"><label>Item Qty</label><input type="number" id="itemQty" value="1" min="1"></div>
            <div class="input-box"><label>Width (cm)</label><input type="number" id="width" placeholder="Ex: 250"></div>
            <div class="input-box"><label>Height (cm)</label><input type="number" id="height" placeholder="Ex: 300"></div>
            <div class="input-box"><label>Note / Remarks</label><input type="text" id="itemNote" placeholder="Any special instruction..."></div>
        </div>
        <div class="input-group" style="background: #fff; padding: 10px; border: 1px dashed #ccc;">
            <div class="input-box"><label>Fabric/Material Price</label><input type="number" id="price"></div>
            <div class="input-box" id="stitchingBox"><label>Stitching Rate (Per Pcs)</label><input type="number" id="stitchCharge" value="0"></div>
            <div class="input-box"><label>Fixing Rate (Per Pcs)</label><input type="number" id="fixCharge" value="0"></div>
        </div>
        <button class="btn btn-add" onclick="addItem()">+ Add to List</button>
    </div>

    <h3>Draft Items</h3>
    <table id="draftTable">
        <thead><tr><th>Location</th><th>Details</th><th>Size</th><th>Total</th><th>Action</th></tr></thead>
        <tbody></tbody>
    </table>
    
    <div style="display:flex; gap:10px; margin-top:20px; background: #eee; padding:10px; border-radius:5px;">
        <div class="input-box"><label>Discount</label><input type="number" id="discountInput" value="0" oninput="calculateGrandTotal()"></div>
        <div class="input-box"><label>Advance (For Invoice)</label><input type="number" id="advanceInput" value="0" style="font-weight:bold; color:green;" oninput="calculateGrandTotal()"></div>
    </div>

    <br>
    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-inv" onclick="generateDocument('invoice')">Invoice</button>
        <button class="btn btn-quote" onclick="generateDocument('quotation')">Quotation</button>
        
        <button class="btn btn-receipt" onclick="openDirectReceiptModal()">üí∞ Receipt (Money In)</button>
        <button class="btn btn-payment admin-only-btn" onclick="openPaymentModal()">üí∏ Payment (Money Out)</button>
        
        <button class="btn btn-stmt" onclick="openStatementModal()">Statement</button> 
        <button class="btn btn-po admin-only-btn" onclick="openPOModal()">Purchase Order</button>
        <button class="btn btn-prod" onclick="generateDocument('production')">Production</button>
    </div>

    <div class="bottom-actions">
        <button class="btn btn-save" onclick="saveCurrentOrder()">üíæ Save Invoice/Order to Cloud</button>
        <div class="admin-controls">
            <button class="btn btn-history" onclick="toggleSavedList()">üìÇ Open History</button>
            <button class="btn btn-sync" onclick="syncFromCloud()">üîÑ Download Data</button>
        </div>
        <button class="btn btn-clear" onclick="clearData()">‚ùå New Order / Clear All</button>
    </div>
</div>

<div class="container" id="docView">
    <header>
        <h1>AMSilks Trading W.L.L.</h1>
        <div class="sub-head">Doha - Qatar | CR No: 224866</div>
        <div class="sub-head">Contact / WhatsApp: 77070221</div>
        <div class="web-info">www.amsilks.com | info@amsilks.com</div>
        <h2 id="docTitle" style="margin-top:10px; color:#555;">INVOICE</h2>
        
        <div style="display:flex; justify-content:space-between; text-align:left; margin-top:20px; border-top: 1px solid #eee; padding-top:10px;">
            <div>
                <strong>To:</strong> <span id="docToName"></span><br>
                <span id="docToPhone"></span>
            </div>
            <div style="text-align: right;">
                <strong>Date:</strong> <span id="docDate"></span><br>
                <strong>Ref:</strong> <span id="docRef"></span>
            </div>
        </div>
    </header>

    <table id="docTable">
        <thead><tr id="tableHeaderRow"></tr></thead>
        <tbody id="docBody"></tbody>
        <tfoot class="price-col" id="docFooter">
            <tr><td id="colspanGap" class="text-right"><strong>Total Amount:</strong></td><td id="subTotal">0.00</td></tr>
            <tr id="trDiscount"><td id="colspanGapDisc" class="text-right"><strong>Discount:</strong></td><td id="dispDiscount">0.00</td></tr>
            <tr id="trPrevBal" style="background-color: #fff3cd;"><td id="colspanGapPrev" class="text-right"><strong>+ Previous Balance:</strong></td><td id="displayPrevBal">0.00</td></tr>
            <tr><td id="colspanGapGrand" class="text-right" style="font-size:16px;"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" style="font-size:16px; font-weight:bold;">0.00</td></tr>
            <tr id="trAdvance"><td id="colspanGapAdv" class="text-right"><strong>- Advance Paid:</strong></td><td id="dispAdvance">0.00</td></tr>
            <tr id="trBalanceDue"><td id="colspanGapBal" class="text-right" style="color: #dc3545;"><strong>BALANCE DUE:</strong></td><td id="balanceDue" style="font-weight:bold; color: #dc3545; font-size:15px; border-top: 2px solid #333;">0.00</td></tr>
        </tfoot>
    </table>

    <div id="receiptBox" class="receipt-box">
        <div class="receipt-row"><div class="receipt-label" id="rcptLabelFrom">Received from:</div><div class="receipt-value" id="rcptName"></div></div>
        <div class="receipt-row"><div class="receipt-label">The sum of:</div><div class="receipt-value" id="rcptWords"></div></div>
        <div class="receipt-row"><div class="receipt-label">Being:</div><div class="receipt-value" id="rcptBeing">Advance / Payment for Curtain Works</div></div>
        <div style="display:flex; justify-content: space-between; align-items: flex-end;">
            <div class="receipt-amount-box">QR <span id="rcptAmount">0.00</span></div>
            <div style="font-size:12px;">Mode: Cash &nbsp;‚òê&nbsp;&nbsp; Card &nbsp;‚òê&nbsp;&nbsp; Cheque &nbsp;‚òê</div>
        </div>
        <div class="receipt-footer"><div class="receipt-sig">Accountant</div><div class="receipt-sig">Receiver's Signature</div></div>
    </div>

    <div id="amountWords" class="amount-words no-print-placeholder"></div>
    <div id="quoteTerms" class="quote-terms"><strong>Terms:</strong> 1. Quotation valid for 15 days. 2. 50% advance required.</div>

    <div class="no-print" style="margin-top: 30px; text-align: center; display: flex; gap: 10px; justify-content: center;">
        <button class="btn btn-save-doc" onclick="saveCurrentOrder()">üíæ Save This Record</button>
        <button class="btn btn-print" onclick="window.print()">Print / PDF</button>
        <button class="btn btn-wa" onclick="sendWhatsapp()">WhatsApp</button>
        <button class="btn btn-close" onclick="closeDoc()">Back / Close</button>
    </div>
</div>

<script>
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwTRm-mr-jkWPwf34CypR0ppqBqMT-YuF1kqRTw7Qes88f8On4A29e2htFpCGl_yoRJ_A/exec";
    
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    window.addEventListener('online', updateNetworkStatus); window.addEventListener('offline', updateNetworkStatus);

    function updateNetworkStatus() {
        let statusDiv = document.getElementById("networkStatus");
        if (navigator.onLine) {
            statusDiv.innerText = "ONLINE - Auto Syncing..."; statusDiv.className = "status-online"; statusDiv.style.display = "block";
            setTimeout(() => { statusDiv.style.display = "none"; syncPendingOrders(); }, 3000);
        } else {
            statusDiv.innerText = "OFFLINE - Saving Locally"; statusDiv.className = "status-offline"; statusDiv.style.display = "block";
        }
    }

    let cart = []; let currentMode = 'invoice'; let globalSubTotal = 0; let currentUserRole = null; 
    let tempDocData = {}; // For holding Name/Amount for Receipts/PO
    const curtainTypes = ["Heavy Curtain", "Sheer Curtain", "Blackout Curtain", "Roller Blind", "Roman Blind", "Other"];

    window.onload = function() { updateRoomOptions(); updateNetworkStatus(); checkPendingSyncs(); populateDatalist(); };

    function checkLogin() {
        let pin = document.getElementById("loginPin").value;
        if(pin === "9999") { loginSuccess("admin"); } else if (pin === "1111") { loginSuccess("sales"); } else { alert("Wrong PIN!"); document.getElementById("loginPin").value = ""; }
    }

    function loginSuccess(role) {
        currentUserRole = role; document.getElementById("loginOverlay").style.display = "none";
        let badge = document.getElementById("userRoleBadge"); badge.innerText = role.toUpperCase(); badge.className = "role-badge " + (role === 'admin' ? "role-admin" : "role-sales");
        if (role === 'admin') { document.querySelector('.admin-controls').style.display = "flex"; document.querySelectorAll('.admin-only-btn').forEach(b => b.style.display = "block"); } 
        else { document.querySelector('.admin-controls').style.display = "none"; document.querySelectorAll('.admin-only-btn').forEach(b => b.style.display = "none"); }
    }

    function logout() { location.reload(); }

    function populateDatalist() {
        let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]");
        let custNames = savedOrders.filter(o => o.custName).map(o => o.custName.trim());
        let suppNames = savedOrders.filter(o => o.suppName).map(o => o.suppName.trim());
        let allNames = [...new Set([...custNames, ...suppNames])];
        let dl = document.getElementById("savedNamesList");
        dl.innerHTML = "";
        allNames.forEach(n => { if(n) { let opt = document.createElement("option"); opt.value = n; dl.appendChild(opt); } });
    }

    // --- DIRECT RECEIPT & PAYMENT LOGIC ---
    function openDirectReceiptModal() { populateDatalist(); document.getElementById("directReceiptModal").style.display = "flex"; }
    
    function generateDirectReceipt() {
        let name = document.getElementById("rcptCustName").value.trim();
        let amt = parseFloat(document.getElementById("rcptCustAmount").value);
        if(!name || !amt) { alert("Enter details"); return; }
        
        document.getElementById("directReceiptModal").style.display = "none";
        // Setup View
        setupDocView('receipt', name, amt, "Payment Received from Customer");
    }

    function openPaymentModal() { populateDatalist(); document.getElementById("paymentModal").style.display = "flex"; }
    
    function generatePaymentVoucher() {
        let name = document.getElementById("paySuppName").value.trim();
        let amt = parseFloat(document.getElementById("payAmount").value);
        if(!name || !amt) { alert("Enter details"); return; }
        
        document.getElementById("paymentModal").style.display = "none";
        // Setup View
        setupDocView('payment', name, amt, "Paid to Supplier");
    }

    function setupDocView(mode, name, amount, desc) {
        currentMode = mode;
        tempDocData = { name: name, amount: amount, desc: desc }; // Store for saving

        document.getElementById("editorSection").style.display = "none";
        document.getElementById("docView").style.display = "block";
        
        let title = (mode === 'receipt') ? "RECEIPT VOUCHER" : "PAYMENT VOUCHER";
        document.getElementById("docTitle").innerText = title;
        document.getElementById("docToName").innerText = name; 
        document.getElementById("docTable").style.display = "none";
        document.getElementById("docFooter").style.display = "none";
        
        let receiptBox = document.getElementById("receiptBox");
        receiptBox.style.display = "block";
        document.getElementById("rcptLabelFrom").innerText = (mode === 'payment') ? "Paid To:" : "Received from:";
        document.getElementById("rcptName").innerText = name;
        document.getElementById("rcptWords").innerText = numberToWords(amount);
        document.getElementById("rcptAmount").innerText = amount.toFixed(2);
        document.getElementById("rcptBeing").innerText = desc || "Account Balance / Advance";
    }

    // --- PO LOGIC ---
    function openPOModal() {
        populateDatalist();
        if (cart.length === 0) { alert("Cart is empty! Add items first."); return; }
        document.getElementById("poModal").style.display = "flex";
        let listContainer = document.getElementById("poListContainer");
        document.getElementById("poSupplierInput").value = ""; 
        listContainer.innerHTML = "";
        cart.forEach((item, index) => {
            let div = document.createElement("div"); div.className = "po-item";
            let checkbox = document.createElement("input"); checkbox.type = "checkbox"; checkbox.id = "chk_" + index; checkbox.value = index; checkbox.checked = true; 
            let label = document.createElement("label"); label.htmlFor = "chk_" + index; label.innerText = `${item.room} - ${item.type} (Fab: ${item.fabricNo})`;
            div.appendChild(checkbox); div.appendChild(label); listContainer.appendChild(div);
        });
    }
    
    function generatePOFromSelection() {
        let suppName = document.getElementById("poSupplierInput").value.trim();
        if (!suppName) { alert("Enter Supplier Name!"); return; }
        
        let selectedIndices = []; 
        document.querySelectorAll("#poListContainer input[type='checkbox']").forEach(chk => { if (chk.checked) selectedIndices.push(parseInt(chk.value)); });
        
        if (selectedIndices.length === 0) { alert("Select items!"); return; }
        let printCart = selectedIndices.map(i => cart[i]); 
        document.getElementById("poModal").style.display = "none";
        
        // Calculate PO Total for saving purposes
        let poTotal = printCart.reduce((sum, item) => sum + (item.totalCost || 0), 0);
        
        tempDocData = { name: suppName, amount: poTotal }; // Store
        generateDocument('po', printCart);
    }

    // --- SAVE LOGIC (CRITICAL FIXES) ---
    function saveCurrentOrder() {
        let orderData = {
            id: Date.now(), 
            date: new Date().toLocaleString(), 
            savedBy: currentUserRole.toUpperCase(), 
            isSynced: false
        };

        if (currentMode === 'receipt') {
            orderData.recordType = 'receipt';
            orderData.custName = tempDocData.name;
            orderData.grandTotal = tempDocData.amount;
            orderData.suppName = ""; 
            orderData.cart = []; // No items for direct receipt
        } else if (currentMode === 'payment') {
            orderData.recordType = 'payment';
            orderData.suppName = tempDocData.name; // Supplier Name
            orderData.grandTotal = tempDocData.amount;
            orderData.custName = "";
            orderData.cart = [];
        } else if (currentMode === 'po') {
            orderData.recordType = 'po'; // Purchase Order (Bill)
            orderData.suppName = tempDocData.name;
            orderData.grandTotal = tempDocData.amount; // Value of goods
            orderData.custName = "";
            orderData.cart = cart; // Ideally filtered items, but saving full cart for simplicity or pass filtered
        } else {
            // Invoice / Quote
            if(cart.length === 0) { alert("Cart empty!"); return; }
            orderData.recordType = currentMode; // 'invoice' or 'quotation'
            orderData.custName = document.getElementById("custName").value.trim();
            orderData.custPhone = document.getElementById("custPhone").value;
            orderData.grandTotal = document.getElementById("grandTotal").innerText;
            orderData.advance = document.getElementById("advanceInput").value;
            orderData.cart = cart;
        }

        let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]");
        savedOrders.push(orderData);
        localStorage.setItem("amsilksSavedOrders", JSON.stringify(savedOrders));

        if (navigator.onLine) {
            let saveBtn = document.querySelector(".btn-save-doc");
            if(saveBtn) saveBtn.innerText = "Syncing...";
            
            fetch(SHEET_API_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(orderData) })
            .then(() => { alert("Saved & Synced!"); markOrderAsSynced(orderData.id); if(saveBtn) saveBtn.innerText = "Saved ‚úî"; })
            .catch(error => { alert("Saved Locally."); checkPendingSyncs(); if(saveBtn) saveBtn.innerText = "Saved (Offline)"; });
        } else { alert("Offline: Saved."); checkPendingSyncs(); }
    }

    // --- STATEMENT LOGIC ---
    function openStatementModal() { populateDatalist(); document.getElementById("statementModal").style.display = "flex"; }

    function generateStatement() {
        let type = document.getElementById("stmtType").value;
        let name = document.getElementById("stmtNameInput").value.trim();
        if(!name) { alert("Enter name"); return; }

        let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]");
        let filtered = [];

        if (type === 'Customer') {
            filtered = savedOrders.filter(o => o.custName && o.custName.toLowerCase() === name.toLowerCase());
        } else {
            filtered = savedOrders.filter(o => o.suppName && o.suppName.toLowerCase() === name.toLowerCase());
        }

        if(filtered.length === 0) { alert("No records for " + name); return; }

        document.getElementById("statementModal").style.display = "none";
        document.getElementById("editorSection").style.display = "none";
        document.getElementById("docView").style.display = "block";
        document.getElementById("docTitle").innerText = type.toUpperCase() + " STATEMENT";
        document.getElementById("docToName").innerText = name;
        
        document.getElementById("docFooter").style.display = "none"; 
        document.getElementById("receiptBox").style.display = "none";
        document.getElementById("docTable").style.display = "table";
        
        let tbody = document.getElementById("docBody");
        let headerRow = document.getElementById("tableHeaderRow");
        tbody.innerHTML = "";

        if (type === 'Customer') {
            headerRow.innerHTML = "<th>Date</th><th>Type</th><th>Bill (Dr)</th><th>Paid (Cr)</th><th>Balance</th>";
            let balance = 0;
            filtered.sort((a, b) => a.id - b.id);

            filtered.forEach(o => {
                let dr = 0, cr = 0;
                let desc = "";

                if (o.recordType === 'invoice') {
                    dr = parseFloat(o.grandTotal) || 0;
                    desc = "Invoice";
                    let adv = parseFloat(o.advance) || 0;
                    if (adv > 0) cr = adv; // Advance is considered payment
                } else if (o.recordType === 'receipt') {
                    cr = parseFloat(o.grandTotal) || 0; 
                    desc = "Receipt";
                }

                if (dr > 0 || cr > 0) {
                    balance = balance + dr - cr;
                    tbody.innerHTML += `<tr><td>${o.date.split(',')[0]}</td><td>${desc}</td><td>${dr > 0 ? dr.toFixed(2) : '-'}</td><td>${cr > 0 ? cr.toFixed(2) : '-'}</td><td><strong>${balance.toFixed(2)}</strong></td></tr>`;
                }
            });
            tbody.innerHTML += `<tr style="background:#eee;font-weight:bold;"><td colspan="4" class="text-right">Net Due:</td><td>${balance.toFixed(2)}</td></tr>`;

        } else {
            // SUPPLIER STATEMENT
            headerRow.innerHTML = "<th>Date</th><th>Type</th><th>Bill (Cr)</th><th>Paid (Dr)</th><th>Balance</th>";
            let balance = 0;
            filtered.sort((a, b) => a.id - b.id);

            filtered.forEach(o => {
                let bill = 0, paid = 0;
                let desc = "";

                if (o.recordType === 'po') {
                    bill = parseFloat(o.grandTotal) || 0; 
                    desc = "Purchased (PO)";
                } else if (o.recordType === 'payment') {
                    paid = parseFloat(o.grandTotal) || 0;
                    desc = "Payment Voucher";
                }

                if (bill > 0 || paid > 0) {
                    // Supplier Balance = Bill (We owe) - Paid (We gave)
                    balance = balance + bill - paid;
                    tbody.innerHTML += `<tr><td>${o.date.split(',')[0]}</td><td>${desc}</td><td>${bill > 0 ? bill.toFixed(2) : '-'}</td><td>${paid > 0 ? paid.toFixed(2) : '-'}</td><td><strong>${balance.toFixed(2)}</strong></td></tr>`;
                }
            });
            tbody.innerHTML += `<tr style="background:#eee;font-weight:bold;"><td colspan="4" class="text-right">Net Payable:</td><td>${balance.toFixed(2)}</td></tr>`;
        }
        currentMode = 'statement';
    }

    // --- DOCUMENT GENERATION (General) ---
    function generateDocument(mode, customCart) {
        currentMode = mode; let itemsToPrint = customCart || cart;
        
        // Validation for invoice/quote
        if((mode === 'invoice' || mode === 'quotation') && itemsToPrint.length === 0) { alert("Add items first!"); return; }

        document.getElementById("editorSection").style.display = "none"; 
        document.getElementById("docView").style.display = "block";
        document.getElementById("amountWords").innerText = ""; 
        document.getElementById("docDate").innerText = new Date().toLocaleDateString(); 
        document.getElementById("docRef").innerText = "AMS-" + Math.floor(Math.random() * 1000);
        
        let docTable = document.getElementById("docTable");
        let receiptBox = document.getElementById("receiptBox");
        
        docTable.style.display = "table"; 
        receiptBox.style.display = "none"; 
        document.getElementById("docFooter").style.display = "table-footer-group";

        if (mode === 'invoice' || mode === 'quotation') {
            document.getElementById("docTitle").innerText = mode.toUpperCase();
            document.getElementById("docToName").innerText = document.getElementById("custName").value;
            document.getElementById("docToPhone").innerText = document.getElementById("custPhone").value;
        } else {
            // Internal / Prod
            document.getElementById("docTitle").innerText = (mode === 'po') ? "PURCHASE ORDER" : "PRODUCTION SHEET";
            document.getElementById("docToName").innerText = (mode === 'po') ? tempDocData.name : "Internal";
            document.getElementById("docFooter").style.display = "none";
        }

        // Render Table Rows
        let tbody = document.getElementById("docBody"); tbody.innerHTML = ""; globalSubTotal = 0;
        itemsToPrint.forEach((item, i) => {
            globalSubTotal += item.totalCost;
            let desc = `${item.type} (Cat: ${item.catalog}, Fab: ${item.fabricNo})`;
            let row = `<tr><td>${i+1}</td><td>${item.room}</td><td>${desc}</td><td>${item.w}x${item.h} m</td><td>${item.itemQty}</td>`;
            if (mode === 'invoice' || mode === 'quotation') row += `<td>${item.price}</td><td>${item.totalCost.toFixed(2)}</td>`;
            tbody.innerHTML += row + "</tr>";
        });

        if (mode === 'invoice' || mode === 'quotation') {
            document.getElementById("subTotal").innerText = globalSubTotal.toFixed(2);
            calculateGrandTotal();
        }
    }

    // --- UTILS (Calculations, Words, etc) ---
    function calculateGrandTotal() {
        let discount = parseFloat(document.getElementById("discountInput").value) || 0;
        let advance = parseFloat(document.getElementById("advanceInput").value) || 0;
        let prevBal = parseFloat(document.getElementById("prevBalanceInput").value) || 0;
        document.getElementById("displayPrevBal").innerText = prevBal.toFixed(2);
        document.getElementById("dispDiscount").innerText = discount.toFixed(2);
        document.getElementById("dispAdvance").innerText = advance.toFixed(2);
        
        let grand = (globalSubTotal - discount) + prevBal;
        let balance = grand - advance;
        
        document.getElementById("grandTotal").innerText = grand.toFixed(2);
        document.getElementById("balanceDue").innerText = balance.toFixed(2);
        document.getElementById("amountWords").innerText = "Amount in Words: " + numberToWords(balance);
    }

    function numberToWords(n) { if (n < 0) return "Negative"; if (n === 0) return "Zero Only"; const a = ['','One ','Two ','Three ','Four ','Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen ']; const b = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety']; const num = parseFloat(n).toFixed(2); let [intP, decP] = num.split('.'); intP = parseInt(intP); decP = parseInt(decP); function cvt(num) { if ((num = num.toString()).length > 9) return 'overflow'; n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/); if (!n) return; var str = ''; str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : ''; str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : ''; str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : ''; str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : ''; str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : ''; return str; } let out = cvt(intP); if(!out) out = "Zero "; out += "Riyals Only"; if(decP > 0) out += " and " + cvt(decP) + " Dirhams"; return out; }
    
    // --- Helper Functions (Standard) ---
    function markOrderAsSynced(id) { let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); let idx = savedOrders.findIndex(o => o.id === id); if(idx !== -1) { savedOrders[idx].isSynced = true; localStorage.setItem("amsilksSavedOrders", JSON.stringify(savedOrders)); checkPendingSyncs(); } }
    function checkPendingSyncs() { let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); let pending = savedOrders.filter(o => !o.isSynced); let btn = document.getElementById("pendingSyncBtn"); if(pending.length > 0) { btn.style.display = "block"; btn.innerText = `‚ö†Ô∏è ${pending.length} Orders Pending Sync`; } else { btn.style.display = "none"; } }
    function syncPendingOrders() { if (!navigator.onLine) { alert("Offline!"); return; } let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); let pending = savedOrders.filter(o => !o.isSynced); if(pending.length === 0) { alert("No pending items."); return; } alert(`Syncing ${pending.length}...`); pending.forEach(order => { fetch(SHEET_API_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(order) }).then(() => markOrderAsSynced(order.id)); }); setTimeout(() => { checkPendingSyncs(); alert("Sync Done"); }, 3000); }
    function syncFromCloud() { if(currentUserRole !== 'admin') { alert("Admin only."); return; } let btn = document.querySelector(".btn-sync"); let ot = btn.innerText; btn.innerText = "Downloading..."; fetch(SHEET_API_URL).then(r => r.json()).then(data => { if (Array.isArray(data)) { let localOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); let unsynced = localOrders.filter(o => !o.isSynced); let cloud = data.map(row => ({ id: row.id, date: row.date, name: row.custName, custName: row.custName, custPhone: row.custPhone, grandTotal: row.grandTotal, advance: row.advance, recordType: row.recordType, suppName: row.suppName, savedBy: row.savedBy || "UNKNOWN", cart: (typeof row.cart === 'string') ? JSON.parse(row.cart) : row.cart, isSynced: true })); let combined = [...unsynced, ...cloud]; const unique = Array.from(new Map(combined.map(item => [item.id, item])).values()); localStorage.setItem("amsilksSavedOrders", JSON.stringify(unique)); alert("Synced!"); showSavedOrders(); } btn.innerText = ot; }).catch(e => { alert("Fail"); btn.innerText = ot; }); }
    function toggleSavedList() { let area = document.getElementById("savedListArea"); area.style.display = (area.style.display === "block") ? "none" : "block"; if(area.style.display === "block") showSavedOrders(); }
    function showSavedOrders() { let container = document.getElementById("savedItemsContainer"); let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); checkPendingSyncs(); container.innerHTML = ""; if (savedOrders.length === 0) { container.innerHTML = "<p>No orders.</p>"; return; } savedOrders.reverse().forEach((order) => { let div = document.createElement("div"); div.className = "saved-item"; let type = order.recordType ? `(${order.recordType.toUpperCase()})` : ""; div.innerHTML = `<div><strong>${order.custName || order.suppName || "Ref"}</strong> ${type}<br> <small>${order.date} | Total: ${order.grandTotal}</small></div><div><button class="btn-add" style="padding:5px 10px; font-size:12px;" onclick="loadOrder(${order.id})">Load</button></div>`; container.appendChild(div); }); }
    function loadOrder(id) { if(!confirm("Load?")) return; let savedOrders = JSON.parse(localStorage.getItem("amsilksSavedOrders") || "[]"); let order = savedOrders.find(o => o.id == id); if (order) { cart = order.cart; document.getElementById("custName").value = order.custName; document.getElementById("custPhone").value = order.custPhone || ""; document.getElementById("discountInput").value = order.discount || 0; document.getElementById("advanceInput").value = order.advance || 0; renderDraft(); document.getElementById("savedListArea").style.display = "none"; } }
    function clearData() { if(confirm("Clear?")) { cart = []; document.querySelectorAll("input").forEach(i => i.value = ""); document.getElementById("itemQty").value = "1"; document.getElementById("stitchCharge").value = "0"; document.getElementById("fixCharge").value = "0"; document.getElementById("fullnessSelect").value = "3"; document.getElementById("fabricWidthSelect").value = "1.4"; document.getElementById("discountInput").value = "0"; document.getElementById("advanceInput").value = "0"; checkCustomFullness(); renderDraft(); } }
    function updateRoomOptions() { let bType = document.getElementById("buildingType").value; let roomSel = document.getElementById("roomSelect"); let manualInput = document.getElementById("manualRoom"); let towerInput = document.getElementById("towerNameInput"); roomSel.innerHTML = ""; towerInput.style.display = (bType === "Tower") ? "block" : "none"; manualInput.style.display = "none"; let options = (bType === "House") ? ["Living Room", "Master Bedroom", "Bedroom 1", "Bedroom 2", "Guest Room", "Majlis", "Kitchen", "Other"] : (bType === "Tower") ? ["Room A", "Room B", "Room C", "Room D", "Living Area", "Kitchen", "Other"] : ["Other"]; options.forEach(opt => { let el = document.createElement("option"); el.value = opt; el.innerText = opt; roomSel.appendChild(el); }); checkManualInput('roomSelect', 'manualRoom'); }
    function checkManualInput(selectId, inputId) { let val = document.getElementById(selectId).value; document.getElementById(inputId).style.display = (val === "Other") ? "block" : "none"; }
    function toggleFields() { let type = document.getElementById("type").value; let isCurtain = curtainTypes.includes(type); document.getElementById("stitchingBox").style.visibility = isCurtain ? "visible" : "hidden"; document.getElementById("fabricWidthBox").style.display = isCurtain ? "block" : "none"; document.getElementById("fullnessBox").style.display = isCurtain ? "block" : "none"; if(!isCurtain) document.getElementById("stitchCharge").value = "0"; }
    function checkCustomFullness() { let val = document.getElementById("fullnessSelect").value; document.getElementById("customFullnessInput").style.display = (val === "custom") ? "block" : "none"; }
    function addItem() { let bType = document.getElementById("buildingType").value; let towerName = document.getElementById("towerNameInput").value; let room = (document.getElementById("roomSelect").value === "Other") ? document.getElementById("manualRoom").value : document.getElementById("roomSelect").value; let floor = (document.getElementById("floorSelect").value === "Other") ? document.getElementById("manualFloor").value : document.getElementById("floorSelect").value; let type = document.getElementById("type").value; let catalog = document.getElementById("catalog").value; let fabricNo = document.getElementById("fabricNo").value; let selectedFabWidth = parseFloat(document.getElementById("fabricWidthSelect").value) || 1.4; let fullnessSelect = document.getElementById("fullnessSelect").value; let fullnessRatio = (fullnessSelect === "2") ? 2 : (fullnessSelect === "custom") ? (parseFloat(document.getElementById("customFullnessInput").value) || 3) : 3; let itemQty = parseInt(document.getElementById("itemQty").value) || 1; let note = document.getElementById("itemNote").value; let w_cm = parseFloat(document.getElementById("width").value); let h_cm = parseFloat(document.getElementById("height").value); if (!w_cm || !h_cm || !room) { alert("Check details!"); return; } let w = w_cm / 100; let h = h_cm / 100; let price = parseFloat(document.getElementById("price").value) || 0; let stitchRate = parseFloat(document.getElementById("stitchCharge").value) || 0; let fixRate = parseFloat(document.getElementById("fixCharge").value) || 0; let fabPerItemCust = 0, fabPerItemSupp = 0, calcNote = "", railroadingUsed = false; let isCurtain = curtainTypes.includes(type); if (isCurtain) { let requiredHeight = h + 0.20; let calculatedFab = 0; if (selectedFabWidth > 2.0 && requiredHeight <= selectedFabWidth) { calculatedFab = w * fullnessRatio; railroadingUsed = true; calcNote = `Wide Fab: (Wx${fullnessRatio})`; } else { let panels = Math.ceil((w * fullnessRatio) / selectedFabWidth); if(panels < 1) panels = 1; calculatedFab = panels * requiredHeight; calcNote = `Vertical (${fullnessRatio}x): ${panels} Pcs`; } fabPerItemCust = calculatedFab; fabPerItemSupp = calculatedFab; } else { let rawArea = w * h; fabPerItemCust = (rawArea < 2.0) ? 2.0 : rawArea; fabPerItemSupp = (rawArea < 1.5) ? 1.5 : rawArea; calcNote = `Area: ${rawArea.toFixed(2)}`; stitchRate = 0; } let totalFabCust = fabPerItemCust * itemQty; let totalFabSupp = fabPerItemSupp * itemQty; let materialCost = totalFabCust * price; let totalStitch = stitchRate * itemQty; let totalFix = fixRate * itemQty; let totalCost = materialCost + totalStitch + totalFix; let calculatedUnitPrice = totalCost / itemQty; cart.push({ bType, towerName, floor, room, type, catalog, fabricNo, selectedFabWidth, fullnessRatio, itemQty, w, h, note, fabPerItemCust, fabPerItemSupp, totalFabCust, totalFabSupp, calcNote, price, stitchRate, fixRate, totalStitch, totalFix, totalCost, calculatedUnitPrice, isCurtain, railroadingUsed }); renderDraft(); document.getElementById("width").value = ""; document.getElementById("height").value = ""; document.getElementById("fabricNo").value = ""; document.getElementById("catalog").value = ""; document.getElementById("itemNote").value = ""; document.getElementById("itemQty").value = "1"; }
    function renderDraft() { let tbody = document.querySelector("#draftTable tbody"); tbody.innerHTML = ""; cart.forEach((item, i) => { let loc = `${item.bType} ${item.towerName ? '('+item.towerName+')' : ''}<br>${item.floor} - ${item.room}`; let fabInfo = `Cat: ${item.catalog}<br>Fab: ${item.fabricNo}`; tbody.innerHTML += `<tr><td>${loc}</td><td>${item.type}<br><small>${fabInfo}</small></td><td>${item.w.toFixed(2)}m x ${item.h.toFixed(2)}m<br><b>Qty: ${item.itemQty}</b></td><td>${item.totalFabCust.toFixed(2)} (Inv)</td><td><button class="btn btn-edit" onclick="editItem(${i})">Edit</button><button class="btn btn-close" style="padding:5px 10px; font-size:12px;" onclick="deleteItem(${i})">X</button></td></tr>`; }); }
    function editItem(i) { let item = cart[i]; document.getElementById("buildingType").value = item.bType; updateRoomOptions(); document.getElementById("towerNameInput").value = item.towerName || ""; document.getElementById("floorSelect").value = (["Ground Floor","Mezzanine Floor","First Floor","Second Floor","Third Floor"].includes(item.floor)) ? item.floor : "Other"; checkManualInput('floorSelect', 'manualFloor'); if(document.getElementById("floorSelect").value === "Other") document.getElementById("manualFloor").value = item.floor; let roomOpts = Array.from(document.getElementById("roomSelect").options).map(o => o.value); if(roomOpts.includes(item.room)) { document.getElementById("roomSelect").value = item.room; } else { document.getElementById("roomSelect").value = "Other"; document.getElementById("manualRoom").style.display = "block"; document.getElementById("manualRoom").value = item.room; } document.getElementById("type").value = item.type; toggleFields(); document.getElementById("fullnessSelect").value = (item.fullnessRatio == 3) ? "3" : (item.fullnessRatio == 2) ? "2" : "custom"; checkCustomFullness(); if(item.fullnessRatio != 3 && item.fullnessRatio != 2) document.getElementById("customFullnessInput").value = item.fullnessRatio; document.getElementById("fabricWidthSelect").value = item.selectedFabWidth; document.getElementById("catalog").value = item.catalog; document.getElementById("fabricNo").value = item.fabricNo; document.getElementById("itemQty").value = item.itemQty; document.getElementById("width").value = item.w * 100; document.getElementById("height").value = item.h * 100; document.getElementById("itemNote").value = item.note; document.getElementById("price").value = item.price; document.getElementById("stitchCharge").value = (item.totalStitch / item.itemQty) || 0; document.getElementById("fixCharge").value = (item.totalFix / item.itemQty) || 0; deleteItem(i); window.scrollTo(0,0); }
    function deleteItem(index) { cart.splice(index, 1); renderDraft(); }
    function closeDoc() { document.getElementById("editorSection").style.display = "block"; document.getElementById("docView").style.display = "none"; }
    function sendWhatsapp() { let phone = document.getElementById("custPhone").value; let name = document.getElementById("custName").value; let headerText = "", text = ""; let grand = document.getElementById("grandTotal").innerText; let balance = document.getElementById("balanceDue").innerText; let advance = document.getElementById("advanceInput").value; let prev = document.getElementById("prevBalanceInput").value; if (currentMode === 'invoice') headerText = `*INVOICE - AMSilks* %0A*Customer:* ${name}`; else if (currentMode === 'quotation') headerText = `*QUOTATION - AMSilks* %0A*Customer:* ${name}`; else if (currentMode === 'receipt') headerText = `*RECEIPT VOUCHER - AMSilks* %0A*Received from:* ${document.getElementById("rcptName").innerText}`; else if (currentMode === 'statement') headerText = `*STATEMENT - AMSilks* %0A*Account:* ${document.getElementById("docToName").innerText}`; else if (currentMode === 'po') headerText = `*PURCHASE ORDER - AMSilks* %0A*Supplier:* ${tempDocData.name}`; else if (currentMode === 'payment') headerText = `*PAYMENT VOUCHER - AMSilks* %0A*Paid To:* ${document.getElementById("rcptName").innerText}`; else headerText = `*PRODUCTION ORDER - AMSilks*`; text = `${headerText} %0A----------------------------%0A`; if (currentMode === 'receipt') { let amt = document.getElementById("rcptAmount").innerText; text += `Received: QR ${amt}%0A`; text += `Being: Advance/Payment for Curtain Works%0A`; text += `Ref: ${document.getElementById("docRef").innerText}`; } else if(currentMode === 'statement') { text += `See attached PDF for detailed statement.`; } else if(currentMode === 'payment') { text += `PAID TO SUPPLIER: ${document.getElementById("rcptName").innerText}%0AAmount: ${document.getElementById("rcptAmount").innerText}%0ARef: ${document.getElementById("docRef").innerText}`; } else { cart.forEach((item, i) => { let tName = (currentMode === 'po' || !item.towerName) ? "" : ` (${item.towerName})`; let methodInfo = (item.isCurtain && currentMode !== 'invoice' && currentMode !== 'quotation') ? ` (1x${item.fullnessRatio})` : ""; text += `*${i+1}. ${item.type}*${tName}%0A   Loc: ${item.floor}/${item.room}%0A   Size: ${item.w.toFixed(2)}x${item.h.toFixed(2)}m | Qty: ${item.itemQty}%0A`; let displayFab = (currentMode === 'invoice' || currentMode === 'quotation') ? item.totalFabCust : item.totalFabSupp; if (currentMode !== 'invoice' && currentMode !== 'quotation') text += `   Fab: ${displayFab.toFixed(2)}${methodInfo}%0A`; if (currentMode === 'invoice' || currentMode === 'quotation') text += `   Total: ${item.totalCost.toFixed(2)}%0A`; text += `%0A`; }); if (currentMode === 'invoice' || currentMode === 'quotation') { text += `----------------------------%0A`; if(parseFloat(prev) > 0) text += `Old Due: ${prev}%0A`; text += `*Grand Total: ${grand}*%0A`; if(currentMode === 'invoice' && parseFloat(advance) > 0) text += `*Advance: ${advance}*%0A`; if(currentMode === 'invoice') text += `*Balance: ${balance}*`; } } window.open(`https://wa.me/${phone}?text=${text}`, '_blank'); }
</script>

</body>
</html>
